<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "API_KEY",
  authDomain: "PROJECT.firebaseapp.com",
  projectId: "PROJECT_ID",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================= SESSION ================= */
function setActiveAdmin(u){ sessionStorage.setItem("activeAdmin",u); }
function getActiveAdmin(){ return sessionStorage.getItem("activeAdmin"); }

/* ================= LOGIN ADMIN ================= */
async function checkAdminLoginUI(){
  const u = adminUsernameUI.value;
  const p = adminPasswordUI.value;

  const snap = await db.collection("admins").doc(u).get();
  if(!snap.exists || snap.data().password !== p){
    alert("Login gagal");
    return;
  }

  setActiveAdmin(u);
  adminFormFields.style.display="block";
  adminWAUI.value = snap.data().wa;
  adminTGUI.value = snap.data().tg;
  updateLinks();
}

/* ================= UPDATE ADMIN ================= */
async function saveAdminUI(){
  await db.collection("admins").doc(getActiveAdmin()).update({
    wa: adminWAUI.value,
    tg: adminTGUI.value
  });
  alert("Data disimpan");
  closeAdminModal();
  updateLinks();
}

/* ================= SUPERADMIN ================= */
async function checkSuperLoginUI(){
  const snap = await db.collection("settings").doc("superadmin").get();
  if(snap.data().password !== superPasswordUI.value){
    alert("Password salah");
    return;
  }
  superFormFields.style.display="block";
  loadAdminList();
}

/* ================= ADD ADMIN ================= */
async function addAdminUI(){
  await db.collection("admins").doc(newAdminUsername.value).set({
    password: newAdminPassword.value,
    wa: newAdminWA.value,
    tg: newAdminTG.value
  });
  alert("Admin ditambahkan");
  loadAdminList();
}

/* ================= DELETE ADMIN ================= */
async function deleteAdminUI(){
  await db.collection("admins").doc(deleteAdminSelect.value).delete();
  alert("Admin dihapus");
  loadAdminList();
}

/* ================= LOAD ADMIN LIST ================= */
async function loadAdminList(){
  const snap = await db.collection("admins").get();
  deleteAdminSelect.innerHTML="";
  snap.forEach(d=>{
    const o=document.createElement("option");
    o.value=d.id;
    o.textContent=d.id;
    deleteAdminSelect.appendChild(o);
  });
}

/* ================= UPDATE LINK ================= */
async function updateLinks(){
  const u=getActiveAdmin();
  if(!u) return;
  const snap = await db.collection("admins").doc(u).get();
  waBtn.href="https://wa.me/"+snap.data().wa;
  tgBtn.href="https://t.me/"+snap.data().tg;
  btnJoinEvent.href="https://wa.me/"+snap.data().wa;
}

/* ================= FORM WA ================= */
async function sendWhatsApp(e){
  e.preventDefault();
  const u=getActiveAdmin();
  if(!u){ alert("Admin belum login"); return; }
  const snap=await db.collection("admins").doc(u).get();
  window.open(`https://wa.me/${snap.data().wa}?text=Nama:${nama.value}%0ANo:${email.value}%0APesan:${pesan.value}`);
}
</script>
