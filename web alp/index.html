<?php
$conn = new mysqli("localhost","DB_USER","DB_PASS","DB_NAME");
if($conn->connect_error) die("DB Error");

header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json");

if(isset($_POST['action'])){
  // ===== LOGIN =====
  if($_POST['action']=="login"){
    $u=$_POST['username'];
    $p=$_POST['password'];
    $q=$conn->prepare("SELECT * FROM admins WHERE username=?");
    $q->bind_param("s",$u);
    $q->execute();
    $r=$q->get_result()->fetch_assoc();
    if($r && $r['password']==PASSWORD($p)){
      unset($r['password']);
      echo json_encode($r);
    }else http_response_code(401);
    exit;
  }

  // ===== UPDATE ADMIN =====
  if($_POST['action']=="update"){
    $q=$conn->prepare("UPDATE admins SET wa=?,tg=? WHERE id=?");
    $q->bind_param("ssi",$_POST['wa'],$_POST['tg'],$_POST['id']);
    $q->execute();
    echo json_encode(["status"=>"ok"]);
    exit;
  }

  // ===== TAMBAH ADMIN =====
  if($_POST['action']=="add"){
    $q=$conn->prepare("INSERT INTO admins(username,password,wa,tg,role)
    VALUES (?,PASSWORD(?),?,?, 'admin')");
    $q->bind_param("ssss",$_POST['u'],$_POST['p'],$_POST['wa'],$_POST['tg']);
    $q->execute();
    echo json_encode(["status"=>"added"]);
    exit;
  }

  // ===== HAPUS ADMIN =====
  if($_POST['action']=="delete"){
    $q=$conn->prepare("DELETE FROM admins WHERE id=? AND role='admin'");
    $q->bind_param("i",$_POST['id']);
    $q->execute();
    echo json_encode(["status"=>"deleted"]);
    exit;
  }
}
?>
<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Alpha Digital</title>
</head>
<body>

<!-- ===== LANDING PAGE KAMU ===== -->
<!-- (SEMUA HTML YANG KAMU PUNYA TETAP DI SINI, TIDAK BERUBAH) -->

<script>
let activeAdmin=null;

// ===== LOGIN ADMIN =====
function adminLogin(){
  const f=new FormData();
  f.append("action","login");
  f.append("username",adminUsernameUI.value);
  f.append("password",adminPasswordUI.value);

  fetch("",{method:"POST",body:f})
  .then(r=>{if(!r.ok) throw 0; return r.json()})
  .then(a=>{
    activeAdmin=a;
    adminFormFields.style.display="block";
    adminWAUI.value=a.wa;
    adminTGUI.value=a.tg;
    updateLinks();
  }).catch(()=>alert("Login gagal"));
}

// ===== UPDATE LINK =====
function updateLinks(){
  waBtn.href="https://wa.me/"+activeAdmin.wa;
  tgBtn.href="https://t.me/"+activeAdmin.tg;
  btnJoinEvent.href="https://wa.me/"+activeAdmin.wa;
}

// ===== SIMPAN ADMIN =====
function saveAdminUI(){
  const f=new FormData();
  f.append("action","update");
  f.append("id",activeAdmin.id);
  f.append("wa",adminWAUI.value);
  f.append("tg",adminTGUI.value);

  fetch("",{method:"POST",body:f})
  .then(()=>alert("Data disimpan"));
}

// ===== TAMBAH ADMIN (SUPERADMIN) =====
function addAdminUI(){
  const f=new FormData();
  f.append("action","add");
  f.append("u",newAdminUsername.value);
  f.append("p",newAdminPassword.value);
  f.append("wa",newAdminWA.value);
  f.append("tg",newAdminTG.value);
  fetch("",{method:"POST",body:f})
  .then(()=>alert("Admin ditambahkan"));
}

// ===== HAPUS ADMIN =====
function deleteAdminUI(){
  const f=new FormData();
  f.append("action","delete");
  f.append("id",deleteAdminSelect.value);
  fetch("",{method:"POST",body:f})
  .then(()=>alert("Admin dihapus"));
}
</script>

</body>
</html>
